# Splits Scripts

This directory contains Foundry scripts for deploying, managing, and interacting with Split contracts. These scripts work with [0xSplits V2](https://github.com/0xSplits/splits-contracts-monorepo) contracts to create and manage revenue sharing mechanisms.

## Overview

The scripts in this directory provide a complete workflow for:
1. **Deploying** splits contracts based on configuration files
2. **Distributing** funds through deployed splits
3. **Checking balances** of deployed splits
4. **Base utilities** for shared functionality

## Scripts

### BaseScript.s.sol

The base contract that provides shared functionality for all other scripts, including:
- Reading and parsing JSON configuration files
- Data structures for splits configuration
- Utility functions for sorting recipients and allocations
- JSON array counting helpers

**Key Features:**
- Supports up to 32 splits per configuration file
- Supports up to 32 allocations per split
- Automatic recipient sorting for deterministic deployment
- Loop detection for nested splits

### DeployScript.s.sol

Deploys Split contracts using the provided SplitFactories based on a configuration file.

**Usage:**
```bash
forge script script/splits/DeployScript.s.sol --sig "run(address,address,string)" \
  --rpc-url <RPC_URL> --broadcast -vvv \
  "<pull_split_factory>" "<push_split_factory>" "<splits_config_file_path>"
```

**Parameters:**
- `pull_split_factory`: Address of the PullSplitFactory contract
- `push_split_factory`: Address of the PushSplitFactory contract  
- `splits_config_file_path`: Path to the JSON configuration file

**Environment Variables:**
- `PRIVATE_KEY`: Private key of the deploying account

**Features:**
- Supports both pull and push split types
- Handles nested splits (splits that reference other splits as recipients)
- Automatically detects and prevents circular dependencies
- Saves deployment addresses to `/deployments/<config_filename>`
- Validates all configuration parameters

**Split Factory Addresses:**
You can find the official SplitFactory addresses in the [0xSplits deployment documentation](https://github.com/0xSplits/splits-contracts-monorepo/tree/main/packages/splits-v2/deployments).

### DistributeScript.s.sol

Calls the `distribute()` function for deployed splits to distribute accumulated funds.

**Usage:**
```bash
forge script script/splits/DistributeScript.s.sol --sig "run(string,string)" \
  --rpc-url <RPC_URL> --broadcast -vvv \
  "<splits_deployment_file_path>" "<splits_config_file_path>"
```

**Parameters:**
- `splits_deployment_file_path`: Path to the deployment JSON file (generated by DeployScript)
- `splits_config_file_path`: Path to the original configuration file

**Environment Variables:**
- `PRIVATE_KEY`: Private key of the account calling distribute

**Features:**
- Distributes native token (ETH) balances
- Reconstructs split configuration for distribution calls
- Works with both pull and push splits
- Requires both deployment and configuration files for validation

### GetBalancesScript.s.sol

Reads and displays the balances of deployed splits.

**Usage:**
```bash
forge script script/splits/GetBalancesScript.s.sol --sig "run(string)" \
  --rpc-url <RPC_URL> -vvv \
  "<splits_deployment_file_path>"
```

**Parameters:**
- `splits_deployment_file_path`: Path to the deployment JSON file

**Environment Variables:**
- `PRIVATE_KEY`: Private key (required but not used for transactions)

**Features:**
- Shows split balance (funds ready for distribution)
- Shows warehouse balance (funds already distributed but not withdrawn)
- Displays balances in gwei for readability
- Read-only operation (no transactions sent)

## Configuration File Format

Splits are configured using JSON files. Here's the expected format:

### Single Split Example
```json
[
    {
        "name": "simple",
        "owner": "0x46aB8712c7A5423b717F648529B1c7A17099750A",
        "totalAllocation": 1000,
        "distributionIncentive": 0,
        "splitType": "pull",
        "allocations": [
            {
                "recipient": "0xE84E904936C595C55b9Ad08532d9aD0A5d76df72",
                "allocation": 500
            },
            {
                "recipient": "0xCaA54030A875F765aCaC38f8DB64b9227912be63",
                "allocation": 500
            }
        ]
    }
]
```

### Nested Splits Example
```json
[
    {
        "name": "obol",
        "owner": "0x46aB8712c7A5423b717F648529B1c7A17099750A",
        "totalAllocation": 1000,
        "distributionIncentive": 0,
        "splitType": "push",
        "allocations": [
            {
                "recipient": "dv",
                "allocation": 900
            },
            {
                "recipient": "0x46aB8712c7A5423b717F648529B1c7A17099750A",
                "allocation": 100
            }
        ]
    },
    {
        "name": "dv",
        "owner": "0x46aB8712c7A5423b717F648529B1c7A17099750A",
        "totalAllocation": 1000,
        "distributionIncentive": 0,
        "splitType": "push",
        "allocations": [
            {
                "recipient": "0xE84E904936C595C55b9Ad08532d9aD0A5d76df72",
                "allocation": 250
            },
            {
                "recipient": "0xCaA54030A875F765aCaC38f8DB64b9227912be63",
                "allocation": 250
            },
            {
                "recipient": "0x2f064dde4BE8854105e551F7407ffE31858559AF",
                "allocation": 250
            },
            {
                "recipient": "0xd2924E80327b74Dc67582909aB738e0697FA2c45",
                "allocation": 250
            }
        ]
    }
]
```

### Configuration Parameters

**Split Object:**
- `name` (string): Unique identifier for the split
- `owner` (address): Address that can update the split
- `totalAllocation` (uint256): Sum of all allocations (typically 1000 for percentages)
- `distributionIncentive` (uint256): Incentive for calling distribute (0-65535)
- `splitType` (string): Either "pull" or "push"
- `allocations` (array): Array of allocation objects

**Allocation Object:**
- `recipient` (string): Either an Ethereum address (0x...) or another split name for nesting
- `allocation` (uint256): Amount allocated to this recipient

## Sample Configuration Files

Sample configuration files are available in `../data/`:
- `single-split-config-sample.json`: Simple split with two recipients
- `nested-split-config-sample.json`: Nested splits with sub-distributions

## Deployment Flow

1. **Create Configuration**: Write a JSON configuration file with your split setup
2. **Deploy Splits**: Use `DeployScript.s.sol` to deploy all splits to the blockchain
3. **Distribute Funds**: Use `DistributeScript.s.sol` to distribute accumulated funds
4. **Check Balances**: Use `GetBalancesScript.s.sol` to monitor split balances

## Important Notes

- **Pull vs Push Splits**: 
  - Pull splits require recipients to withdraw their funds
  - Push splits automatically send funds to recipients
- **Nested Splits**: Recipients can reference other splits by name for complex distribution trees
- **Loop Detection**: The deployment script prevents circular dependencies
- **Gas Considerations**: Distribution calls consume gas; consider setting appropriate `distributionIncentive`
- **Permissions**: Only the split owner can update split configurations after deployment

## Requirements

- Foundry installation
- Access to deployed SplitFactory contracts
- Funded deployer account for gas fees
- Valid RPC endpoint for target network

## Troubleshooting

- **"PRIVATE_KEY is not set"**: Ensure your private key environment variable is properly configured
- **"Loop detected"**: Check your configuration for circular references between splits
- **"No splits found"**: Verify your JSON configuration file format and path
- **Deployment failures**: Ensure sufficient gas and proper factory addresses
